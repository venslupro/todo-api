# Todo API - 系统架构文档

## 概述

Todo API 是一个基于 Go 语言开发的现代化 TODO 列表应用后端服务，采用微服务架构设计，支持用户认证、团队协作、实时更新和媒体文件存储等功能。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            客户端层 (Client Layer)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  Web前端  │ 移动应用  │ 第三方集成  │ 命令行工具  │ Postman/API测试工具           │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API网关层 (API Gateway)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│  HTTP/1.1 (REST) │  HTTP/2 (gRPC) │  WebSocket  │ 健康检查  │ 指标收集         │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          应用服务层 (Application Layer)                       │
├─────────────────────────────────────────────────────────────────────────────┤
│  认证服务   │  TODO服务  │  团队服务   │  媒体服务   │  实时服务   │  系统服务     │
│ AuthService │ TodoService│ TeamService│MediaService│RealTimeService│SystemService│
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          领域层 (Domain Layer)                             │
├─────────────────────────────────────────────────────────────────────────────┤
│   用户实体   │  TODO实体  │  团队实体   │  媒体实体   │  活动实体   │  错误处理    │
│    User     │    Todo    │    Team    │   Media    │  Activity   │   Errors    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        基础设施层 (Infrastructure Layer)                    │
├─────────────────────────────────────────────────────────────────────────────┤
│ PostgreSQL │   Redis   │   AWS S3   │  迁移管理   │  配置管理   │  日志系统    │
│  数据库     │  缓存层    │ 对象存储    │ Migrations │   Config   │   Logging   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 组件详细说明

### 1. 客户端层 (Client Layer)

**功能**:
- Web前端应用 (React/Vue/Angular)
- 移动应用 (iOS/Android)
- 第三方集成 (Zapier, Slack等)
- 命令行工具
- API测试工具 (Postman, curl)

**通信协议**:
- HTTP/1.1 (REST API)
- HTTP/2 (gRPC)
- WebSocket (实时通信)

### 2. API网关层 (API Gateway)

**核心组件**:
- **gRPC-Gateway**: 提供 RESTful API 接口
- **gRPC Server**: 高性能 RPC 服务
- **WebSocket Server**: 实时通信服务
- **健康检查端点**: `/health`
- **指标收集**: Prometheus metrics

**特性**:
- JWT 认证中间件
- 请求限流
- CORS 支持
- 请求日志记录
- 错误处理统一化

### 3. 应用服务层 (Application Layer)

#### 3.1 认证服务 (AuthService)
**职责**:
- 用户注册和登录
- JWT token 生成和验证
- 密码哈希和验证
- 会话管理

#### 3.2 TODO服务 (TodoService)
**职责**:
- TODO 项目的 CRUD 操作
- 任务状态管理
- 优先级和标签管理
- 搜索和过滤功能

#### 3.3 团队服务 (TeamService)
**职责**:
- 团队创建和管理
- 团队成员管理
- 权限控制
- 团队协作功能

#### 3.4 媒体服务 (MediaService)
**职责**:
- 文件上传和下载
- AWS S3 集成
- 媒体文件元数据管理
- 文件类型验证

#### 3.5 实时服务 (RealTimeService)
**职责**:
- WebSocket 连接管理
- 实时消息广播
- 在线状态跟踪
- 事件通知

#### 3.6 系统服务 (SystemService)
**职责**:
- 系统健康检查
- 性能指标收集
- 配置管理
- 系统监控

### 4. 领域层 (Domain Layer)

#### 核心实体
- **User**: 用户信息、认证数据
- **Todo**: TODO项目、状态、优先级
- **Team**: 团队信息、成员关系
- **Media**: 媒体文件元数据
- **Activity**: 用户活动日志

#### 业务规则
- 用户权限验证
- 数据完整性约束
- 业务逻辑验证
- 领域事件发布

### 5. 基础设施层 (Infrastructure Layer)

#### 5.1 数据存储
- **PostgreSQL**: 主数据库，存储结构化数据
- **Redis**: 缓存层，会话存储，实时数据
- **AWS S3**: 对象存储，媒体文件存储

#### 5.2 数据迁移
- 版本化数据库迁移
- 回滚支持
- 迁移状态跟踪

#### 5.3 配置管理
- 环境变量配置
- 配置文件管理
- 密钥管理

## 数据流示例

### 1. 用户注册流程
```
客户端 → API网关 → 认证服务 → 用户仓库 → PostgreSQL → 返回JWT token
```

### 2. 创建TODO流程
```
客户端 → API网关 → TODO服务 → 领域验证 → TODO仓库 → PostgreSQL → 实时服务 → WebSocket广播
```

### 3. 文件上传流程
```
客户端 → API网关 → 媒体服务 → 文件验证 → AWS S3上传 → 媒体仓库 → PostgreSQL → 返回文件URL
```

## 部署架构

### 开发环境
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   Todo API  │───▶│ PostgreSQL  │    │    Redis    │
│  (localhost)│    │  (Docker)   │    │   (Docker)  │
└─────────────┘    └─────────────┘    └─────────────┘
```

### 生产环境 (Kubernetes)
```
┌─────────────────────────────────────────────────────────────┐
│                    Kubernetes Cluster                       │
├─────────────────┬─────────────────┬─────────────────────────┤
│   Todo API      │   PostgreSQL    │         Redis          │
│   Deployment    │   StatefulSet   │      Deployment         │
│   (3 replicas)  │   (主从复制)     │      (哨兵模式)         │
└─────────────────┴─────────────────┴─────────────────────────┘
         │               │                 │
         ▼               ▼                 ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  Load       │    │  Persistent │    │  Persistent │
│  Balancer   │    │  Volume     │    │  Volume     │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 技术栈

### 后端技术
- **语言**: Go 1.19+
- **框架**: 标准库 + 自定义架构
- **API**: gRPC + gRPC-Gateway
- **认证**: JWT
- **数据库**: PostgreSQL
- **缓存**: Redis
- **存储**: AWS S3

### 部署和运维
- **容器化**: Docker
- **编排**: Kubernetes
- **服务发现**: Kubernetes Service
- **配置管理**: ConfigMap + Secrets
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack

### 开发工具
- **协议定义**: Protocol Buffers
- **API文档**: OpenAPI 3.0
- **代码生成**: buf
- **测试**: Go test + testify
- **CI/CD**: GitHub Actions

## 安全架构

### 认证和授权
- JWT token 认证
- 基于角色的访问控制 (RBAC)
- API 密钥管理
- 会话超时控制

### 数据安全
- 密码加盐哈希 (bcrypt)
- 数据传输加密 (HTTPS/TLS)
- 数据库连接加密
- 敏感数据脱敏

### 网络安全
- 防火墙规则
- 请求限流
- IP 白名单
- DDoS 防护

## 性能优化

### 缓存策略
- Redis 缓存热点数据
- 数据库查询优化
- 连接池管理
- 懒加载模式

### 扩展性设计
- 无状态服务设计
- 水平扩展支持
- 数据库分片准备
- 消息队列集成准备

## 监控和日志

### 应用监控
- 健康检查端点
- 性能指标收集
- 错误跟踪
- 业务指标监控

### 系统监控
- 资源使用率
- 网络流量
- 存储性能
- 服务可用性

### 日志管理
- 结构化日志
- 日志级别控制
- 日志聚合
- 审计日志

## 故障恢复

### 高可用设计
- 多副本部署
- 自动故障转移
- 数据备份策略
- 灾难恢复计划

### 容错机制
- 优雅降级
- 断路器模式
- 重试机制
- 超时控制

---

*本文档遵循 Google 文档风格，提供清晰的系统架构视图和技术实现细节。*