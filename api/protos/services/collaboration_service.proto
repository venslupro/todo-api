syntax = "proto3";

package todo.services;

option go_package = "api/protos/services;todopb";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "api/protos/common/enums.proto";
import "api/protos/common/errors.proto";
import "api/protos/common/messages.proto";
import "api/protos/common/pagination.proto";


// Collaboration Service - Handles real-time updates
service CollaborationService {
  // Real-time collaboration stream (WebSocket/Server-Sent Events)
  rpc SubscribeToUpdates(SubscribeToUpdatesRequest) returns (stream CollaborationMessage) {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Subscribe to updates"
      description: "Real-time subscription to collaboration updates (WebSocket/SSE)"
    };
  }

  // 获取用户在线状态
  rpc GetUserPresence(GetUserPresenceRequest) returns (GetUserPresenceResponse) {
    option (google.api.http) = {
      get: "/v1/collaboration/presence/{user_id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get user presence"
      description: "Get user's online presence status"
    };
  }

  // 更新在线状态
  rpc UpdatePresence(UpdatePresenceRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/collaboration/presence"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Update presence"
      description: "Update user's presence status"
    };
  }

  // 列出活跃用户
  rpc ListActiveUsers(ListActiveUsersRequest) returns (ListActiveUsersResponse) {
    option (google.api.http) = {
      get: "/v1/collaboration/active-users"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "List active users"
      description: "List currently active users in teams/lists"
    };
  }

  // 锁定资源（防止编辑冲突）
  rpc LockResource(LockResourceRequest) returns (LockResourceResponse) {
    option (google.api.http) = {
      post: "/v1/collaboration/lock"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Lock resource"
      description: "Lock resource for editing (prevent conflicts)"
    };
  }

  // 解锁资源
  rpc UnlockResource(UnlockResourceRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/collaboration/unlock"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Unlock resource"
      description: "Unlock previously locked resource"
    };
  }
}

// 请求/响应消息
message SubscribeToUpdatesRequest {
  string team_id = 1;
  optional string list_id = 2;
  optional string todo_id = 3;
  repeated string channels = 4;  // 订阅的频道
}

message GetUserPresenceRequest {
  string user_id = 1;
}

message GetUserPresenceResponse {
  common.UserPresence presence = 1;
}

message UpdatePresenceRequest {
  string status = 1;  // online, away, offline, busy
  optional string current_activity = 2;
  optional string team_id = 3;
  optional string list_id = 4;
  optional string todo_id = 5;
}

message ListActiveUsersRequest {
  optional string team_id = 1;
  optional string list_id = 2;
  int32 page_size = 3;
  string page_token = 4;
}

message ListActiveUsersResponse {
  repeated common.UserPresence users = 1;
  common.PaginationInfo pagination = 2;
  int32 total_active = 3;
}

message LockResourceRequest {
  string resource_type = 1;  // todo, list
  string resource_id = 2;
  optional int32 timeout_seconds = 3;  // 锁定超时时间（默认5分钟）
}

message LockResourceResponse {
  string lock_id = 1;
  google.protobuf.Timestamp locked_until = 2;
  string locked_by = 3;
}

message UnlockResourceRequest {
  string resource_type = 1;
  string resource_id = 2;
  optional string lock_id = 3;  // 如果为空，则解锁该用户的所有锁
}