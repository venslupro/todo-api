syntax = "proto3";

package todo.services;

option go_package = "api/protos/services;todopb";

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "protoc-gen-openapiv2/options/annotations.proto";
import "api/protos/common/errors.proto";
import "api/protos/common/pagination.proto";

// Notification Service
service NotificationService {
  // Get notifications
  rpc GetNotifications(GetNotificationsRequest) returns (GetNotificationsResponse) {
    option (google.api.http) = {
      get: "/v1/notifications"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get notifications"
      description: "Get user notifications with pagination"
    };
  }

  // 标记通知为已读
  rpc MarkNotificationRead(MarkNotificationReadRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/notifications/{id}/read"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Mark notification read"
      description: "Mark notification as read"
    };
  }

  // 标记所有通知为已读
  rpc MarkAllNotificationsRead(MarkAllNotificationsReadRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      post: "/v1/notifications/read-all"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Mark all notifications read"
      description: "Mark all notifications as read"
    };
  }

  // 删除通知
  rpc DeleteNotification(DeleteNotificationRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      delete: "/v1/notifications/{id}"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Delete notification"
      description: "Delete notification by ID"
    };
  }

  // 获取通知偏好设置
  rpc GetNotificationPreferences(GetNotificationPreferencesRequest) returns (GetNotificationPreferencesResponse) {
    option (google.api.http) = {
      get: "/v1/notifications/preferences"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Get notification preferences"
      description: "Get user's notification preferences"
    };
  }

  // 更新通知偏好设置
  rpc UpdateNotificationPreferences(UpdateNotificationPreferencesRequest) returns (google.protobuf.Empty) {
    option (google.api.http) = {
      patch: "/v1/notifications/preferences"
      body: "*"
    };
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Update notification preferences"
      description: "Update user's notification preferences"
    };
  }

  // 订阅实时通知
  rpc SubscribeToNotifications(SubscribeToNotificationsRequest) returns (stream Notification) {
    option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
      summary: "Subscribe to notifications"
      description: "Real-time subscription to notifications"
    };
  }
}

// 通知消息
message Notification {
  string id = 1;
  string user_id = 2;
  string type = 3;  // todo_assigned, comment_added, due_date_reminder, etc.
  string title = 4;
  string message = 5;
  map<string, string> data = 6;  // 额外数据，如todo_id, comment_id等
  bool is_read = 7;
  bool is_important = 8;
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp read_at = 10;
  google.protobuf.Timestamp expires_at = 11;
}

// 请求/响应消息
message GetNotificationsRequest {
  bool unread_only = 1;
  optional string type = 2;
  optional google.protobuf.Timestamp since = 3;
  int32 page_size = 4;
  string page_token = 5;
}

message GetNotificationsResponse {
  repeated Notification notifications = 1;
  common.PaginationInfo pagination = 2;
  int32 unread_count = 3;
}

message MarkNotificationReadRequest {
  string id = 1;
}

message MarkAllNotificationsReadRequest {}

message DeleteNotificationRequest {
  string id = 1;
}

message NotificationPreference {
  string channel = 1;  // email, push, in_app
  string type = 2;     // 通知类型
  bool enabled = 3;
  map<string, string> settings = 4;  // 频道特定设置
}

message GetNotificationPreferencesRequest {}

message GetNotificationPreferencesResponse {
  repeated NotificationPreference preferences = 1;
}

message UpdateNotificationPreferencesRequest {
  repeated NotificationPreference preferences = 1;
}

message SubscribeToNotificationsRequest {
  optional string type = 1;
}